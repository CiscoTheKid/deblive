<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Data to CSV - DinerEnBlanc System</title>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Container and layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* Main content */
        .content {
            padding: 30px;
        }

        /* Export options section */
        .export-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .export-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        /* Form groups */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        /* Checkbox group */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 5px;
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
            user-select: none;
        }

        /* Date range inputs */
        .date-range {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .date-input {
            flex: 1;
        }

        input[type="date"], input[type="text"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="date"]:focus, input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        button {
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9, #21618c);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        /* Preview section */
        .preview-section {
            margin-top: 30px;
            display: none;
        }

        .preview-section.active {
            display: block;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .preview-header h3 {
            color: #2c3e50;
        }

        .record-count {
            background: #e9ecef;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        /* Table styles */
        .table-container {
            overflow-x: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e9ecef;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Status badges */
        .status-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-returned {
            background: #cce5ff;
            color: #004085;
        }

        /* Loading spinner */
        .spinner {
            display: none;
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .spinner.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert messages */
        .alert {
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.active {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Quick select buttons */
        .quick-select {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .quick-select button {
            padding: 5px 12px;
            font-size: 0.9em;
        }

        /* Statistics cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <h1>üìä Export Data to CSV</h1>
            <p>Export user and package data for comparison with JotForm submissions</p>
        </div>

        <!-- Main Content -->
        <div class="content">
            <!-- Alert Messages -->
            <div id="alertMessage" class="alert"></div>

            <!-- Statistics Section -->
            <div class="stats-grid" id="statsGrid" style="display: none;">
                <div class="stat-card">
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalPackages">0</div>
                    <div class="stat-label">Total Packages</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeRentals">0</div>
                    <div class="stat-label">Active Rentals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="returnedRentals">0</div>
                    <div class="stat-label">Returned</div>
                </div>
            </div>

            <!-- Export Options Section -->
            <div class="export-section">
                <h2>Export Options</h2>
                
                <!-- Fields to Include -->
                <div class="form-group">
                    <label>Select Fields to Export:</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="field_id" value="id" checked>
                            <label for="field_id">User ID</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="field_first_name" value="first_name" checked>
                            <label for="field_first_name">First Name</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="field_last_name" value="last_name" checked>
                            <label for="field_last_name">Last Name</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="field_email" value="email" checked>
                            <label for="field_email">Email</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="field_city" value="city" checked>
                            <label for="field_city">City</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="field_package_type" value="package_type" checked>
                            <label for="field_package_type">Package Type</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="field_package_quantity" value="package_quantity" checked>
                            <label for="field_package_quantity">Package Quantity</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="field_qr_code" value="qr_code_number" checked>
                            <label for="field_qr_code">QR Code</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="field_rental_status" value="rental_status" checked>
                            <label for="field_rental_status">Rental Status</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="field_available_packages" value="available_packages">
                            <label for="field_available_packages">Available Packages</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="field_rented_packages" value="rented_packages">
                            <label for="field_rented_packages">Rented Packages</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="field_created_at" value="created_at">
                            <label for="field_created_at">Created Date</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="field_updated_at" value="updated_at">
                            <label for="field_updated_at">Updated Date</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="field_notes" value="notes">
                            <label for="field_notes">Notes</label>
                        </div>
                    </div>
                    <div class="quick-select">
                        <button type="button" class="btn-secondary" onclick="selectAllFields()">Select All</button>
                        <button type="button" class="btn-secondary" onclick="deselectAllFields()">Deselect All</button>
                        <button type="button" class="btn-secondary" onclick="selectBasicFields()">Basic Fields Only</button>
                    </div>
                </div>

                <!-- Filter by Status -->
                <div class="form-group">
                    <label for="statusFilter">Filter by Rental Status:</label>
                    <select id="statusFilter">
                        <option value="all">All Users</option>
                        <option value="0">Not Active (Status = 0)</option>
                        <option value="1">Active Rentals (Status = 1)</option>
                        <option value="2">Returned (Status = 2)</option>
                    </select>
                </div>

                <!-- Filter by City -->
                <div class="form-group">
                    <label for="cityFilter">Filter by City:</label>
                    <input type="text" id="cityFilter" placeholder="e.g., Washington DC, Boston (leave empty for all)">
                </div>

                <!-- Date Range Filter -->
                <div class="form-group">
                    <label>Filter by Date Range (Optional):</label>
                    <div class="date-range">
                        <div class="date-input">
                            <input type="date" id="dateFrom" placeholder="From Date">
                        </div>
                        <span>to</span>
                        <div class="date-input">
                            <input type="date" id="dateTo" placeholder="To Date">
                        </div>
                    </div>
                </div>

                <!-- Export Format Options -->
                <div class="form-group">
                    <label for="exportFormat">Export Format:</label>
                    <select id="exportFormat">
                        <option value="csv">CSV (Comma Separated)</option>
                        <option value="csv-excel">CSV (Excel Compatible)</option>
                        <option value="tsv">TSV (Tab Separated)</option>
                    </select>
                </div>

                <!-- Action Buttons -->
                <div class="button-group">
                    <button type="button" class="btn-primary" onclick="previewData()">
                        üîç Preview Data
                    </button>
                    <button type="button" class="btn-success" onclick="exportData()">
                        ‚¨áÔ∏è Export to CSV
                    </button>
                    <button type="button" class="btn-secondary" onclick="loadStatistics()">
                        üìà Show Statistics
                    </button>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="spinner" class="spinner"></div>

            <!-- Preview Section -->
            <div id="previewSection" class="preview-section">
                <div class="preview-header">
                    <h3>Data Preview</h3>
                    <span class="record-count">Records: <span id="recordCount">0</span></span>
                </div>
                <div class="table-container">
                    <table id="previewTable">
                        <thead id="previewTableHead">
                            <!-- Headers will be dynamically inserted -->
                        </thead>
                        <tbody id="previewTableBody">
                            <!-- Data rows will be dynamically inserted -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables to store fetched data
        let currentData = null;

        // Function to select all fields
        function selectAllFields() {
            document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
        }

        // Function to deselect all fields
        function deselectAllFields() {
            document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }

        // Function to select only basic fields
        function selectBasicFields() {
            const basicFields = ['id', 'first_name', 'last_name', 'email', 'city', 
                                'package_type', 'package_quantity', 'qr_code_number'];
            document.querySelectorAll('.checkbox-item input[type="checkbox"]').forEach(cb => {
                cb.checked = basicFields.includes(cb.value);
            });
        }

        // Function to get selected fields
        function getSelectedFields() {
            const fields = [];
            document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked').forEach(cb => {
                fields.push(cb.value);
            });
            return fields;
        }

        // Function to show alert message
        function showAlert(message, type = 'info') {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.className = `alert alert-${type} active`;
            alertDiv.textContent = message;
            setTimeout(() => {
                alertDiv.classList.remove('active');
            }, 5000);
        }

        // Function to show/hide spinner
        function toggleSpinner(show) {
            const spinner = document.getElementById('spinner');
            if (show) {
                spinner.classList.add('active');
            } else {
                spinner.classList.remove('active');
            }
        }

        // Function to load statistics
        async function loadStatistics() {
            try {
                toggleSpinner(true);
                const response = await fetch('/api/export-csv-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'stats'
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch statistics');
                }

                const data = await response.json();
                
                // Update statistics display
                document.getElementById('totalUsers').textContent = data.stats.total_users || 0;
                document.getElementById('totalPackages').textContent = data.stats.total_packages || 0;
                document.getElementById('activeRentals').textContent = data.stats.active_rentals || 0;
                document.getElementById('returnedRentals').textContent = data.stats.returned_rentals || 0;
                
                // Show statistics grid
                document.getElementById('statsGrid').style.display = 'grid';
                
                showAlert('Statistics loaded successfully', 'success');
            } catch (error) {
                showAlert(`Error loading statistics: ${error.message}`, 'error');
            } finally {
                toggleSpinner(false);
            }
        }

        // Function to preview data
        async function previewData() {
            try {
                toggleSpinner(true);
                
                // Get filter values
                const filters = {
                    status: document.getElementById('statusFilter').value,
                    city: document.getElementById('cityFilter').value,
                    dateFrom: document.getElementById('dateFrom').value,
                    dateTo: document.getElementById('dateTo').value,
                    fields: getSelectedFields()
                };

                // Validate at least one field is selected
                if (filters.fields.length === 0) {
                    showAlert('Please select at least one field to export', 'error');
                    return;
                }

                // Fetch data from API
                const response = await fetch('/api/export-csv-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'preview',
                        filters: filters
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }

                const data = await response.json();
                currentData = data;

                // Display preview
                displayPreview(data);
                
                showAlert(`Preview loaded: ${data.data.length} records found`, 'success');
            } catch (error) {
                showAlert(`Error loading preview: ${error.message}`, 'error');
            } finally {
                toggleSpinner(false);
            }
        }

        // Function to display preview table
        function displayPreview(data) {
            const previewSection = document.getElementById('previewSection');
            const tableHead = document.getElementById('previewTableHead');
            const tableBody = document.getElementById('previewTableBody');
            const recordCount = document.getElementById('recordCount');
            
            // Clear existing content
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            // Update record count
            recordCount.textContent = data.data.length;
            
            // Create headers
            if (data.headers && data.headers.length > 0) {
                const headerRow = document.createElement('tr');
                data.headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = formatHeaderName(header);
                    headerRow.appendChild(th);
                });
                tableHead.appendChild(headerRow);
            }
            
            // Create data rows (show first 20 for preview)
            const previewData = data.data.slice(0, 20);
            previewData.forEach(row => {
                const tr = document.createElement('tr');
                data.headers.forEach(header => {
                    const td = document.createElement('td');
                    const value = row[header];
                    
                    // Format special fields
                    if (header === 'rental_status') {
                        td.innerHTML = formatRentalStatus(value);
                    } else if (header === 'created_at' || header === 'updated_at') {
                        td.textContent = formatDate(value);
                    } else {
                        td.textContent = value || '';
                    }
                    
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
            
            // Show preview section
            previewSection.classList.add('active');
        }

        // Function to format header names
        function formatHeaderName(header) {
            return header.replace(/_/g, ' ')
                        .replace(/\b\w/g, l => l.toUpperCase());
        }

        // Function to format rental status
        function formatRentalStatus(status) {
            const statusMap = {
                0: '<span class="status-badge status-inactive">Not Active</span>',
                1: '<span class="status-badge status-active">Active</span>',
                2: '<span class="status-badge status-returned">Returned</span>'
            };
            return statusMap[status] || status;
        }

        // Function to format date
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Function to export data to CSV
        async function exportData() {
            try {
                toggleSpinner(true);
                
                // Get filter values
                const filters = {
                    status: document.getElementById('statusFilter').value,
                    city: document.getElementById('cityFilter').value,
                    dateFrom: document.getElementById('dateFrom').value,
                    dateTo: document.getElementById('dateTo').value,
                    fields: getSelectedFields(),
                    format: document.getElementById('exportFormat').value
                };

                // Validate at least one field is selected
                if (filters.fields.length === 0) {
                    showAlert('Please select at least one field to export', 'error');
                    return;
                }

                // Fetch CSV data from API
                const response = await fetch('/api/export-csv-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'export',
                        filters: filters
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to export data');
                }

                // Get the blob from response
                const blob = await response.blob();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                const timestamp = new Date().toISOString().split('T')[0];
                const extension = filters.format === 'tsv' ? 'tsv' : 'csv';
                a.href = url;
                a.download = `dinerenblanc_export_${timestamp}.${extension}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                showAlert('Data exported successfully!', 'success');
            } catch (error) {
                showAlert(`Error exporting data: ${error.message}`, 'error');
            } finally {
                toggleSpinner(false);
            }
        }

        // Initialize page on load
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default for date filters
            const today = new Date().toISOString().split('T')[0];
            
            // Load initial statistics
            loadStatistics();
        });
    </script>
</body>
</html>