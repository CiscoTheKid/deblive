{% extends "base.html" %}
{% block title %}Admin Panel - Database Management{% endblock %}
{% block content %}
<div class="container mx-auto p-4">
    <!-- Header Section -->
    <div class="bg-white shadow-lg rounded-lg p-6 mb-8">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Admin Panel</h1>
                <p class="text-gray-600">Database Management & Inventory Overview</p>
            </div>
            <div class="flex space-x-4">
                <button onclick="refreshStats()" class="px-4 py-2 bg-green-400 text-white rounded hover:bg-green-700 transition duration-200">
                    üîÑ Refresh Status
                </button>
                <a href="/">
                    <button class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200">
                        üè† Home
                    </button>
                </a>
            </div>
        </div>
        <div class="text-sm text-gray-500">
            Last Updated: <span id="lastUpdated">-</span>
        </div>
    </div>

    <!-- Enhanced Stats Cards Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
        <!-- Total Users Card -->
        <div class="bg-white shadow rounded-lg p-6 hover:shadow-lg transition duration-200">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-gray-700 font-medium">Total Users</h3>
                    <p class="text-xs text-gray-500 mt-1">Registered customers</p>
                </div>
                <span id="totalUsers" class="text-2xl font-bold text-blue-600">-</span>
            </div>
        </div>

        <!-- Total QR Codes Card -->
        <div class="bg-white shadow rounded-lg p-6 hover:shadow-lg transition duration-200">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-gray-700 font-medium">Total QR Codes</h3>
                    <p class="text-xs text-gray-500 mt-1">Generated codes</p>
                </div>
                <span id="totalQRCodes" class="text-2xl font-bold text-green-600">-</span>
            </div>
        </div>

        <!-- Active Rentals Card -->
        <div class="bg-white shadow rounded-lg p-6 hover:shadow-lg transition duration-200">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-gray-700 font-medium">Active Rentals</h3>
                    <p class="text-xs text-gray-500 mt-1">Currently rented</p>
                </div>
                <span id="activeRentals" class="text-2xl font-bold text-purple-600">-</span>
            </div>
        </div>

        <!-- Total Packages Card -->
        <div class="bg-white shadow rounded-lg p-6 hover:shadow-lg transition duration-200">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-gray-700 font-medium">Total Packages</h3>
                    <p class="text-xs text-gray-500 mt-1">Total inventory items</p>
                </div>
                <span id="totalPackages" class="text-2xl font-bold text-orange-600">-</span>
            </div>
        </div>

        <!-- Available Packages Card -->
        <div class="bg-white shadow rounded-lg p-6 hover:shadow-lg transition duration-200">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-gray-700 font-medium">Available Packages</h3>
                    <p class="text-xs text-gray-500 mt-1">Ready for rental</p>
                </div>
                <span id="availablePackages" class="text-2xl font-bold text-teal-600">-</span>
            </div>
        </div>

        <!-- Rented Packages Card -->
        <div class="bg-white shadow rounded-lg p-6 hover:shadow-lg transition duration-200">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-gray-700 font-medium">Rented Packages</h3>
                    <p class="text-xs text-gray-500 mt-1">Currently out</p>
                </div>
                <span id="rentedPackages" class="text-2xl font-bold text-red-600">-</span>
            </div>
        </div>
    </div>

    <!-- Package Inventory Summary -->
    <div class="bg-white shadow-lg rounded-lg p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4">üì¶ Inventory Overview</h2>
        <div class="bg-gray-50 rounded-lg p-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-teal-600" id="availablePercentage">-%</div>
                    <div class="text-sm text-gray-600">Available</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-600" id="rentedPercentage">-%</div>
                    <div class="text-sm text-gray-600">Rented Out</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="utilization">-%</div>
                    <div class="text-sm text-gray-600">Utilization Rate</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Management Section -->
    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <h2 class="text-xl font-bold text-gray-800">üóÑÔ∏è Database Management</h2>
        </div>
        
        <div class="p-6">
            <div class="bg-orange-50 rounded-lg p-4 mb-4 border-l-4 border-orange-400">
                <div class="flex items-center text-orange-800">
                    <span class="font-medium">‚ö†Ô∏è Warning: Database Operations</span>
                </div>
                <p class="mt-2 text-sm text-orange-700">
                    The following operations are irreversible and will delete ALL data including:
                </p>
                <ul class="mt-2 text-sm text-orange-700 list-disc list-inside">
                    <li>All user accounts and contact information</li>
                    <li>All QR codes and email logs</li>
                    <li>All rental history and status records</li>
                    <li><strong>All package inventory items</strong></li>
                </ul>
                <p class="mt-2 text-sm text-orange-700 font-semibold">
                    Please proceed with extreme caution.
                </p>
            </div>

            <div class="flex space-x-4">
                <button onclick="showResetConfirmation()" 
                        class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-200 font-medium">
                    üóëÔ∏è Reset Database
                </button>
                
                <button onclick="exportData()" 
                        class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-200 font-medium">
                    üíæ Export Data (Coming Soon)
                </button>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-md mx-4 shadow-2xl">
            <div class="bg-red-50 px-6 py-4 border-b border-red-100 rounded-t-lg">
                <h3 class="text-xl font-bold text-red-700">‚ö†Ô∏è FINAL WARNING: Database Reset</h3>
            </div>
            <div class="px-6 py-4">
                <p class="text-gray-800 mb-3">
                    <strong>This will permanently delete:</strong>
                </p>
                <ul class="list-disc list-inside text-sm text-gray-700 mb-4 space-y-1">
                    <li>All <span id="modalTotalUsers">-</span> user accounts</li>
                    <li>All <span id="modalTotalPackages">-</span> package inventory items</li>
                    <li>All <span id="modalTotalQRCodes">-</span> QR codes</li>
                    <li>All rental history and email logs</li>
                </ul>
                <p class="mt-3 font-bold text-red-600">This action CANNOT be undone!</p>
            </div>
            <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-4 rounded-b-lg">
                <button onclick="hideResetConfirmation()" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition duration-200">
                    ‚ùå Cancel - Keep Data Safe
                </button>
                <button onclick="resetDatabase()" 
                        class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition duration-200 font-bold">
                    ‚úÖ Delete Everything
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
            <p class="text-gray-700 font-medium">Processing database operation...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Function to format date and time
    function formatDateTime(date) {
        return new Date(date).toLocaleString();
    }

    // Function to calculate and display percentages
    function updateInventoryPercentages(stats) {
        const total = stats.total_packages || 0;
        const available = stats.available_packages || 0;
        const rented = stats.rented_packages || 0;

        if (total > 0) {
            const availablePercent = Math.round((available / total) * 100);
            const rentedPercent = Math.round((rented / total) * 100);
            const utilization = Math.round((rented / total) * 100);

            document.getElementById('availablePercentage').textContent = availablePercent + '%';
            document.getElementById('rentedPercentage').textContent = rentedPercent + '%';
            document.getElementById('utilization').textContent = utilization + '%';
        } else {
            document.getElementById('availablePercentage').textContent = '0%';
            document.getElementById('rentedPercentage').textContent = '0%';
            document.getElementById('utilization').textContent = '0%';
        }
    }

    // Function to update all statistics
    async function refreshStats() {
        try {
            const response = await fetch('/api/stats');
            const data = await response.json();
            
            // Update basic stats
            document.getElementById('totalUsers').textContent = data.total_users || 0;
            document.getElementById('totalQRCodes').textContent = data.total_qr_codes || 0;
            document.getElementById('activeRentals').textContent = data.active_rentals || 0;
            
            // Update package inventory stats
            document.getElementById('totalPackages').textContent = data.total_packages || 0;
            document.getElementById('availablePackages').textContent = data.available_packages || 0;
            document.getElementById('rentedPackages').textContent = data.rented_packages || 0;
            
            // Update percentages and ratios
            updateInventoryPercentages(data);
            
            // Update modal stats
            document.getElementById('modalTotalUsers').textContent = data.total_users || 0;
            document.getElementById('modalTotalPackages').textContent = data.total_packages || 0;
            document.getElementById('modalTotalQRCodes').textContent = data.total_qr_codes || 0;
            
            // Update timestamp
            document.getElementById('lastUpdated').textContent = formatDateTime(new Date());
            
        } catch (error) {
            console.error('Error fetching stats:', error);
            
            // Show error state
            const errorElements = [
                'totalUsers', 'totalQRCodes', 'activeRentals', 
                'totalPackages', 'availablePackages', 'rentedPackages'
            ];
            errorElements.forEach(id => {
                document.getElementById(id).textContent = 'Error';
            });
            
            alert('Failed to fetch statistics. Please check your connection and try again.');
        }
    }

    // Function to show reset confirmation modal with current stats
    function showResetConfirmation() {
        // Refresh stats to show current numbers in modal
        refreshStats().then(() => {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        });
    }

    // Function to hide reset confirmation modal
    function hideResetConfirmation() {
        const modal = document.getElementById('confirmModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Function to show loading overlay
    function showLoading() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.remove('hidden');
        overlay.classList.add('flex');
    }

    // Function to hide loading overlay
    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        overlay.classList.add('hidden');
        overlay.classList.remove('flex');
    }

    // Function to reset database
    async function resetDatabase() {
        try {
            showLoading();
            hideResetConfirmation();
            
            const response = await fetch('/api/reset-database', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            
            // Refresh stats to show empty database
            await refreshStats();
            
            hideLoading();
            alert('‚úÖ Database reset successful! All data has been cleared.');
            
        } catch (error) {
            console.error('Error resetting database:', error);
            hideLoading();
            alert('‚ùå Failed to reset database. Please try again or check the server logs.');
        }
    }

    // Placeholder function for future data export feature
    function exportData() {
        alert('üìä Data export feature coming soon! This will allow you to backup your data before resetting.');
    }

    // Auto-refresh stats every 10 seconds (increased from 5 for less server load)
    setInterval(refreshStats, 10000);

    // Initial load when page opens
    document.addEventListener('DOMContentLoaded', function() {
        refreshStats();
    });
</script>
{% endblock %}